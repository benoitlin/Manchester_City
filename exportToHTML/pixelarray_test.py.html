<html>
<head>
<title>pixelarray_test.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
pixelarray_test.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">gc</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">unittest</span>
<span class="s0">import </span><span class="s1">weakref</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">reduce</span>

<span class="s0">from </span><span class="s1">pygame.tests.test_utils </span><span class="s0">import </span><span class="s1">SurfaceSubclass</span>

<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">from </span><span class="s1">pygame.tests.test_utils </span><span class="s0">import </span><span class="s1">arrinter</span>
<span class="s0">except </span><span class="s1">NameError:</span>
    <span class="s0">pass</span>

<span class="s0">import </span><span class="s1">pygame</span>


<span class="s1">IS_PYPY = </span><span class="s2">&quot;PyPy&quot; </span><span class="s1">== platform.python_implementation()</span>


<span class="s0">class </span><span class="s1">TestMixin:</span>
    <span class="s0">def </span><span class="s1">assert_surfaces_equal(self</span><span class="s0">, </span><span class="s1">s1</span><span class="s0">, </span><span class="s1">s2</span><span class="s0">, </span><span class="s1">msg=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s3">&quot;&quot;&quot;Checks if two surfaces are equal in size and color.&quot;&quot;&quot;</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = s1.get_size()</span>

        <span class="s1">self.assertTupleEqual((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s1">s2.get_size()</span><span class="s0">, </span><span class="s1">msg)</span>

        <span class="s1">msg = </span><span class="s2">&quot;&quot; </span><span class="s0">if </span><span class="s1">msg </span><span class="s0">is None else </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">msg</span><span class="s0">}</span><span class="s2">, &quot;</span>
        <span class="s1">msg += </span><span class="s2">f&quot;size: (</span><span class="s0">{</span><span class="s1">w</span><span class="s0">}</span><span class="s2">, </span><span class="s0">{</span><span class="s1">h</span><span class="s0">}</span><span class="s2">)&quot;</span>

        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(w):</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(h):</span>
                <span class="s1">self.assertEqual(</span>
                    <span class="s1">s1.get_at((x</span><span class="s0">, </span><span class="s1">y))</span><span class="s0">,</span>
                    <span class="s1">s2.get_at((x</span><span class="s0">, </span><span class="s1">y))</span><span class="s0">,</span>
                    <span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">msg</span><span class="s0">}</span><span class="s2">, position: (</span><span class="s0">{</span><span class="s1">x</span><span class="s0">}</span><span class="s2">, </span><span class="s0">{</span><span class="s1">y</span><span class="s0">}</span><span class="s2">)&quot;</span><span class="s0">,</span>
                <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">assert_surface_filled(self</span><span class="s0">, </span><span class="s1">surface</span><span class="s0">, </span><span class="s1">expected_color</span><span class="s0">, </span><span class="s1">msg=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s3">&quot;&quot;&quot;Checks if the surface is filled with the given color.&quot;&quot;&quot;</span>
        <span class="s1">width</span><span class="s0">, </span><span class="s1">height = surface.get_size()</span>

        <span class="s1">surface.lock()  </span><span class="s4"># Lock for possible speed up.</span>
        <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">((x</span><span class="s0">, </span><span class="s1">y) </span><span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(height) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(width)):</span>
            <span class="s1">self.assertEqual(surface.get_at(pos)</span><span class="s0">, </span><span class="s1">expected_color</span><span class="s0">, </span><span class="s1">msg)</span>
        <span class="s1">surface.unlock()</span>


<span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;pypy having issues&quot;</span><span class="s1">)</span>
<span class="s0">class </span><span class="s1">PixelArrayTypeTest(unittest.TestCase</span><span class="s0">, </span><span class="s1">TestMixin):</span>
    <span class="s0">def </span><span class="s1">test_compare(self):</span>
        <span class="s4"># __doc__ (as of 2008-06-25) for pygame.pixelarray.PixelArray.compare:</span>

        <span class="s4"># PixelArray.compare (array, distance=0, weights=(0.299, 0.587, 0.114)): Return PixelArray</span>
        <span class="s4"># Compares the PixelArray with another one.</span>

        <span class="s1">w = </span><span class="s5">10</span>
        <span class="s1">h = </span><span class="s5">20</span>
        <span class="s1">size = w</span><span class="s0">, </span><span class="s1">h</span>
        <span class="s1">sf = pygame.Surface(size</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">sf2 = pygame.Surface(size</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">self.assertRaises(TypeError</span><span class="s0">, </span><span class="s1">ar.compare</span><span class="s0">, </span><span class="s1">sf2)</span>
        <span class="s1">ar2 = pygame.PixelArray(sf2)</span>
        <span class="s1">ar3 = ar.compare(ar2)</span>
        <span class="s1">self.assertTrue(isinstance(ar3</span><span class="s0">, </span><span class="s1">pygame.PixelArray))</span>
        <span class="s1">self.assertEqual(ar3.shape</span><span class="s0">, </span><span class="s1">size)</span>
        <span class="s1">sf2.fill(pygame.Color(</span><span class="s2">&quot;white&quot;</span><span class="s1">))</span>
        <span class="s1">self.assert_surfaces_equal(sf2</span><span class="s0">, </span><span class="s1">ar3.surface)</span>
        <span class="s0">del </span><span class="s1">ar3</span>
        <span class="s1">r = pygame.Rect(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">13</span><span class="s1">)</span>
        <span class="s1">sf.fill(pygame.Color(</span><span class="s2">&quot;blue&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">r)</span>
        <span class="s1">sf2.fill(pygame.Color(</span><span class="s2">&quot;red&quot;</span><span class="s1">))</span>
        <span class="s1">sf2.fill(pygame.Color(</span><span class="s2">&quot;blue&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">r)</span>
        <span class="s1">ar3 = ar.compare(ar2)</span>
        <span class="s1">sf.fill(pygame.Color(</span><span class="s2">&quot;white&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">r)</span>
        <span class="s1">self.assert_surfaces_equal(sf</span><span class="s0">, </span><span class="s1">ar3.surface)</span>

        <span class="s4"># FINISH ME!</span>
        <span class="s4"># Test other bit depths, slices, and distance != 0.</span>

    <span class="s0">def </span><span class="s1">test_compare__same_colors_within_distance(self):</span>
        <span class="s3">&quot;&quot;&quot;Ensures compare works correctly with same colored surfaces.&quot;&quot;&quot;</span>
        <span class="s1">size = (</span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">pixelarray_result_color = pygame.Color(</span><span class="s2">&quot;white&quot;</span><span class="s1">)</span>
        <span class="s1">surface_color = (</span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">depth </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">expected_pixelarray_surface = pygame.Surface(size</span><span class="s0">, </span><span class="s1">depth=depth)</span>
            <span class="s1">expected_pixelarray_surface.fill(pixelarray_result_color)</span>

            <span class="s4"># Copy the surface to ensure same dimensions/formatting.</span>
            <span class="s1">surf_a = expected_pixelarray_surface.copy()</span>
            <span class="s1">surf_a.fill(surface_color)</span>
            <span class="s4"># For non-32 bit depths, the actual color can be different from what</span>
            <span class="s4"># was filled.</span>
            <span class="s1">expected_surface_color = surf_a.get_at((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>

            <span class="s1">pixelarray_a = pygame.PixelArray(surf_a)</span>
            <span class="s1">pixelarray_b = pygame.PixelArray(surf_a.copy())</span>

            <span class="s0">for </span><span class="s1">distance </span><span class="s0">in </span><span class="s1">(</span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">0.01</span><span class="s0">, </span><span class="s5">0.1</span><span class="s0">, </span><span class="s5">1.0</span><span class="s1">):</span>
                <span class="s1">pixelarray_result = pixelarray_a.compare(</span>
                    <span class="s1">pixelarray_b</span><span class="s0">, </span><span class="s1">distance=distance</span>
                <span class="s1">)</span>

                <span class="s4"># Ensure the resulting pixelarray is correct and that the original</span>
                <span class="s4"># surfaces were not changed.</span>
                <span class="s1">self.assert_surfaces_equal(</span>
                    <span class="s1">pixelarray_result.surface</span><span class="s0">,</span>
                    <span class="s1">expected_pixelarray_surface</span><span class="s0">,</span>
                    <span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span><span class="s0">,</span>
                <span class="s1">)</span>
                <span class="s1">self.assert_surface_filled(</span>
                    <span class="s1">pixelarray_a.surface</span><span class="s0">, </span><span class="s1">expected_surface_color</span><span class="s0">, </span><span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span>
                <span class="s1">)</span>
                <span class="s1">self.assert_surface_filled(</span>
                    <span class="s1">pixelarray_b.surface</span><span class="s0">, </span><span class="s1">expected_surface_color</span><span class="s0">, </span><span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span>
                <span class="s1">)</span>

            <span class="s1">pixelarray_a.close()</span>
            <span class="s1">pixelarray_b.close()</span>
            <span class="s1">pixelarray_result.close()</span>

    <span class="s0">def </span><span class="s1">test_compare__different_colors_within_distance(self):</span>
        <span class="s3">&quot;&quot;&quot;Ensures compare works correctly with different colored surfaces 
        and the color difference is within the given distance. 
        &quot;&quot;&quot;</span>
        <span class="s1">size = (</span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">pixelarray_result_color = pygame.Color(</span><span class="s2">&quot;white&quot;</span><span class="s1">)</span>
        <span class="s1">surface_a_color = (</span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>
        <span class="s1">surface_b_color = (</span><span class="s5">128</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">depth </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">expected_pixelarray_surface = pygame.Surface(size</span><span class="s0">, </span><span class="s1">depth=depth)</span>
            <span class="s1">expected_pixelarray_surface.fill(pixelarray_result_color)</span>

            <span class="s4"># Copy the surface to ensure same dimensions/formatting.</span>
            <span class="s1">surf_a = expected_pixelarray_surface.copy()</span>
            <span class="s1">surf_a.fill(surface_a_color)</span>
            <span class="s4"># For non-32 bit depths, the actual color can be different from what</span>
            <span class="s4"># was filled.</span>
            <span class="s1">expected_surface_a_color = surf_a.get_at((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">pixelarray_a = pygame.PixelArray(surf_a)</span>

            <span class="s1">surf_b = expected_pixelarray_surface.copy()</span>
            <span class="s1">surf_b.fill(surface_b_color)</span>
            <span class="s4"># For non-32 bit depths, the actual color can be different from what</span>
            <span class="s4"># was filled.</span>
            <span class="s1">expected_surface_b_color = surf_b.get_at((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">pixelarray_b = pygame.PixelArray(surf_b)</span>

            <span class="s0">for </span><span class="s1">distance </span><span class="s0">in </span><span class="s1">(</span><span class="s5">0.2</span><span class="s0">, </span><span class="s5">0.3</span><span class="s0">, </span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">1.0</span><span class="s1">):</span>
                <span class="s1">pixelarray_result = pixelarray_a.compare(</span>
                    <span class="s1">pixelarray_b</span><span class="s0">, </span><span class="s1">distance=distance</span>
                <span class="s1">)</span>

                <span class="s4"># Ensure the resulting pixelarray is correct and that the original</span>
                <span class="s4"># surfaces were not changed.</span>
                <span class="s1">self.assert_surfaces_equal(</span>
                    <span class="s1">pixelarray_result.surface</span><span class="s0">,</span>
                    <span class="s1">expected_pixelarray_surface</span><span class="s0">,</span>
                    <span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span><span class="s0">,</span>
                <span class="s1">)</span>
                <span class="s1">self.assert_surface_filled(</span>
                    <span class="s1">pixelarray_a.surface</span><span class="s0">, </span><span class="s1">expected_surface_a_color</span><span class="s0">, </span><span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span>
                <span class="s1">)</span>
                <span class="s1">self.assert_surface_filled(</span>
                    <span class="s1">pixelarray_b.surface</span><span class="s0">, </span><span class="s1">expected_surface_b_color</span><span class="s0">, </span><span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span>
                <span class="s1">)</span>

            <span class="s1">pixelarray_a.close()</span>
            <span class="s1">pixelarray_b.close()</span>
            <span class="s1">pixelarray_result.close()</span>

    <span class="s0">def </span><span class="s1">test_compare__different_colors_not_within_distance(self):</span>
        <span class="s3">&quot;&quot;&quot;Ensures compare works correctly with different colored surfaces 
        and the color difference is not within the given distance. 
        &quot;&quot;&quot;</span>
        <span class="s1">size = (</span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">pixelarray_result_color = pygame.Color(</span><span class="s2">&quot;black&quot;</span><span class="s1">)</span>
        <span class="s1">surface_a_color = (</span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>
        <span class="s1">surface_b_color = (</span><span class="s5">128</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">127</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">depth </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">expected_pixelarray_surface = pygame.Surface(size</span><span class="s0">, </span><span class="s1">depth=depth)</span>
            <span class="s1">expected_pixelarray_surface.fill(pixelarray_result_color)</span>

            <span class="s4"># Copy the surface to ensure same dimensions/formatting.</span>
            <span class="s1">surf_a = expected_pixelarray_surface.copy()</span>
            <span class="s1">surf_a.fill(surface_a_color)</span>
            <span class="s4"># For non-32 bit depths, the actual color can be different from what</span>
            <span class="s4"># was filled.</span>
            <span class="s1">expected_surface_a_color = surf_a.get_at((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">pixelarray_a = pygame.PixelArray(surf_a)</span>

            <span class="s1">surf_b = expected_pixelarray_surface.copy()</span>
            <span class="s1">surf_b.fill(surface_b_color)</span>
            <span class="s4"># For non-32 bit depths, the actual color can be different from what</span>
            <span class="s4"># was filled.</span>
            <span class="s1">expected_surface_b_color = surf_b.get_at((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">pixelarray_b = pygame.PixelArray(surf_b)</span>

            <span class="s0">for </span><span class="s1">distance </span><span class="s0">in </span><span class="s1">(</span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">0.00001</span><span class="s0">, </span><span class="s5">0.0001</span><span class="s0">, </span><span class="s5">0.001</span><span class="s1">):</span>
                <span class="s1">pixelarray_result = pixelarray_a.compare(</span>
                    <span class="s1">pixelarray_b</span><span class="s0">, </span><span class="s1">distance=distance</span>
                <span class="s1">)</span>

                <span class="s4"># Ensure the resulting pixelarray is correct and that the original</span>
                <span class="s4"># surfaces were not changed.</span>
                <span class="s1">self.assert_surfaces_equal(</span>
                    <span class="s1">pixelarray_result.surface</span><span class="s0">,</span>
                    <span class="s1">expected_pixelarray_surface</span><span class="s0">,</span>
                    <span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span><span class="s0">,</span>
                <span class="s1">)</span>
                <span class="s1">self.assert_surface_filled(</span>
                    <span class="s1">pixelarray_a.surface</span><span class="s0">, </span><span class="s1">expected_surface_a_color</span><span class="s0">, </span><span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span>
                <span class="s1">)</span>
                <span class="s1">self.assert_surface_filled(</span>
                    <span class="s1">pixelarray_b.surface</span><span class="s0">, </span><span class="s1">expected_surface_b_color</span><span class="s0">, </span><span class="s1">(depth</span><span class="s0">, </span><span class="s1">distance)</span>
                <span class="s1">)</span>

            <span class="s1">pixelarray_a.close()</span>
            <span class="s1">pixelarray_b.close()</span>
            <span class="s1">pixelarray_result.close()</span>

    <span class="s0">def </span><span class="s1">test_close(self):</span>
        <span class="s3">&quot;&quot;&quot;does not crash when it is deleted.&quot;&quot;&quot;</span>
        <span class="s1">s = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>
        <span class="s1">a = pygame.PixelArray(s)</span>
        <span class="s1">a.close()</span>
        <span class="s0">del </span><span class="s1">a</span>

    <span class="s0">def </span><span class="s1">test_close_raises(self):</span>
        <span class="s3">&quot;&quot;&quot;when you try to do an operation after it is closed.&quot;&quot;&quot;</span>
        <span class="s1">s = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>
        <span class="s1">a = pygame.PixelArray(s)</span>
        <span class="s1">a.close()</span>

        <span class="s0">def </span><span class="s1">do_operation():</span>
            <span class="s1">a[:]</span>

        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">do_operation)</span>

        <span class="s0">def </span><span class="s1">do_operation2():</span>
            <span class="s1">a[:] = </span><span class="s5">1</span>

        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">do_operation2)</span>

        <span class="s0">def </span><span class="s1">do_operation3():</span>
            <span class="s1">a.make_surface()</span>

        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">do_operation3)</span>

        <span class="s0">def </span><span class="s1">do_operation4():</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">a:</span>
                <span class="s0">pass</span>

        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">do_operation4)</span>

    <span class="s0">def </span><span class="s1">test_context_manager(self):</span>
        <span class="s3">&quot;&quot;&quot;closes properly.&quot;&quot;&quot;</span>
        <span class="s1">s = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">))</span>
        <span class="s0">with </span><span class="s1">pygame.PixelArray(s) </span><span class="s0">as </span><span class="s1">a:</span>
            <span class="s1">a[:]</span>

        <span class="s4"># Test pixel array write... will also catch refcount issues and</span>
        <span class="s4"># segfault</span>
        <span class="s0">with </span><span class="s1">pygame.PixelArray(s) </span><span class="s0">as </span><span class="s1">a:</span>
            <span class="s1">a[:] = pygame.Color(</span><span class="s2">&quot;deepskyblue&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pixel_array(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s1">self.assertEqual(ar._pixels_address</span><span class="s0">, </span><span class="s1">sf._pixels_address)</span>

            <span class="s0">if </span><span class="s1">sf.mustlock():</span>
                <span class="s1">self.assertTrue(sf.get_locked())</span>

            <span class="s1">self.assertEqual(len(ar)</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span>

            <span class="s0">del </span><span class="s1">ar</span>
            <span class="s0">if </span><span class="s1">sf.mustlock():</span>
                <span class="s1">self.assertFalse(sf.get_locked())</span>

    <span class="s0">def </span><span class="s1">test_as_class(self):</span>
        <span class="s4"># Check general new-style class freatures.</span>
        <span class="s1">sf = pygame.Surface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">self.assertRaises(AttributeError</span><span class="s0">, </span><span class="s1">getattr</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s2">&quot;nonnative&quot;</span><span class="s1">)</span>
        <span class="s1">ar.nonnative = </span><span class="s2">&quot;value&quot;</span>
        <span class="s1">self.assertEqual(ar.nonnative</span><span class="s0">, </span><span class="s2">&quot;value&quot;</span><span class="s1">)</span>
        <span class="s1">r = weakref.ref(ar)</span>
        <span class="s1">self.assertTrue(r() </span><span class="s0">is </span><span class="s1">ar)</span>
        <span class="s0">del </span><span class="s1">ar</span>
        <span class="s1">gc.collect()</span>
        <span class="s1">self.assertTrue(r() </span><span class="s0">is None</span><span class="s1">)</span>

        <span class="s0">class </span><span class="s1">C(pygame.PixelArray):</span>
            <span class="s0">def </span><span class="s1">__str__(self):</span>
                <span class="s0">return </span><span class="s2">&quot;string (%i, %i)&quot; </span><span class="s1">% self.shape</span>

        <span class="s1">ar = C(sf)</span>
        <span class="s1">self.assertEqual(str(ar)</span><span class="s0">, </span><span class="s2">&quot;string (2, 3)&quot;</span><span class="s1">)</span>
        <span class="s1">r = weakref.ref(ar)</span>
        <span class="s1">self.assertTrue(r() </span><span class="s0">is </span><span class="s1">ar)</span>
        <span class="s0">del </span><span class="s1">ar</span>
        <span class="s1">gc.collect()</span>
        <span class="s1">self.assertTrue(r() </span><span class="s0">is None</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_pixelarray__subclassed_surface(self):</span>
        <span class="s3">&quot;&quot;&quot;Ensure the PixelArray constructor accepts subclassed surfaces.&quot;&quot;&quot;</span>
        <span class="s1">surface = SurfaceSubclass((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">pixelarray = pygame.PixelArray(surface)</span>

        <span class="s1">self.assertIsInstance(pixelarray</span><span class="s0">, </span><span class="s1">pygame.PixelArray)</span>

    <span class="s4"># Sequence interfaces</span>
    <span class="s0">def </span><span class="s1">test_get_column(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">6</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">val = sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(len(ar2)</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2.__getitem__(</span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar2.__getitem__(</span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar2.__getitem__(</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">val)</span>

            <span class="s1">ar2 = ar.__getitem__(-</span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(len(ar2)</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2.__getitem__(</span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar2.__getitem__(</span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar2.__getitem__(</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">val)</span>

    <span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;pypy malloc abort&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_get_pixel(self):</span>
        <span class="s1">w = </span><span class="s5">10</span>
        <span class="s1">h = </span><span class="s5">20</span>
        <span class="s1">size = w</span><span class="s0">, </span><span class="s1">h</span>
        <span class="s1">bg_color = (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>
        <span class="s1">fg_color_y = (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">128</span><span class="s1">)</span>
        <span class="s1">fg_color_x = (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">11</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface(size</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">mapped_bg_color = sf.map_rgb(bg_color)</span>
            <span class="s1">mapped_fg_color_y = sf.map_rgb(fg_color_y)</span>
            <span class="s1">mapped_fg_color_x = sf.map_rgb(fg_color_x)</span>
            <span class="s1">self.assertNotEqual(</span>
                <span class="s1">mapped_fg_color_y</span><span class="s0">,</span>
                <span class="s1">mapped_bg_color</span><span class="s0">,</span>
                <span class="s2">&quot;Unusable test colors for bpp %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">self.assertNotEqual(</span>
                <span class="s1">mapped_fg_color_x</span><span class="s0">,</span>
                <span class="s1">mapped_bg_color</span><span class="s0">,</span>
                <span class="s2">&quot;Unusable test colors for bpp %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">self.assertNotEqual(</span>
                <span class="s1">mapped_fg_color_y</span><span class="s0">,</span>
                <span class="s1">mapped_fg_color_x</span><span class="s0">,</span>
                <span class="s2">&quot;Unusable test colors for bpp %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">sf.fill(bg_color)</span>

            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s1">ar_y = ar.__getitem__(</span><span class="s5">1</span><span class="s1">)</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(h):</span>
                <span class="s1">ar2 = ar_y.__getitem__(y)</span>
                <span class="s1">self.assertEqual(</span>
                    <span class="s1">ar2</span><span class="s0">,</span>
                    <span class="s1">mapped_bg_color</span><span class="s0">,</span>
                    <span class="s2">&quot;ar[1][%i] == %i, mapped_bg_color == %i&quot;</span>
                    <span class="s1">% (y</span><span class="s0">, </span><span class="s1">ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color)</span><span class="s0">,</span>
                <span class="s1">)</span>

                <span class="s1">sf.set_at((</span><span class="s5">1</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">fg_color_y)</span>
                <span class="s1">ar2 = ar_y.__getitem__(y)</span>
                <span class="s1">self.assertEqual(</span>
                    <span class="s1">ar2</span><span class="s0">,</span>
                    <span class="s1">mapped_fg_color_y</span><span class="s0">,</span>
                    <span class="s2">&quot;ar[1][%i] == %i, mapped_fg_color_y == %i&quot;</span>
                    <span class="s1">% (y</span><span class="s0">, </span><span class="s1">ar2</span><span class="s0">, </span><span class="s1">mapped_fg_color_y)</span><span class="s0">,</span>
                <span class="s1">)</span>

            <span class="s1">sf.set_at((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">bg_color)</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(w):</span>
                <span class="s1">ar2 = ar.__getitem__(x).__getitem__(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">self.assertEqual(</span>
                    <span class="s1">ar2</span><span class="s0">,</span>
                    <span class="s1">mapped_bg_color</span><span class="s0">,</span>
                    <span class="s2">&quot;ar[%i][1] = %i, mapped_bg_color = %i&quot; </span><span class="s1">% (x</span><span class="s0">, </span><span class="s1">ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color)</span><span class="s0">,</span>
                <span class="s1">)</span>
                <span class="s1">sf.set_at((x</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fg_color_x)</span>
                <span class="s1">ar2 = ar.__getitem__(x).__getitem__(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">self.assertEqual(</span>
                    <span class="s1">ar2</span><span class="s0">,</span>
                    <span class="s1">mapped_fg_color_x</span><span class="s0">,</span>
                    <span class="s2">&quot;ar[%i][1] = %i, mapped_fg_color_x = %i&quot;</span>
                    <span class="s1">% (x</span><span class="s0">, </span><span class="s1">ar2</span><span class="s0">, </span><span class="s1">mapped_fg_color_x)</span><span class="s0">,</span>
                <span class="s1">)</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">0</span><span class="s1">).__getitem__(</span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">1</span><span class="s1">).__getitem__(</span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_fg_color_y</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(-</span><span class="s5">4</span><span class="s1">).__getitem__(</span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_fg_color_x</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(-</span><span class="s5">4</span><span class="s1">).__getitem__(</span><span class="s5">5</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(-</span><span class="s5">4</span><span class="s1">).__getitem__(</span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(-w + </span><span class="s5">1</span><span class="s1">).__getitem__(</span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_fg_color_y</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(-w).__getitem__(</span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">5</span><span class="s1">).__getitem__(-</span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">5</span><span class="s1">).__getitem__(-h + </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_fg_color_x</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">5</span><span class="s1">).__getitem__(-h)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">0</span><span class="s1">).__getitem__(-h + </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_fg_color_x</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

            <span class="s1">ar2 = ar.__getitem__(</span><span class="s5">0</span><span class="s1">).__getitem__(-h)</span>
            <span class="s1">self.assertEqual(ar2</span><span class="s0">, </span><span class="s1">mapped_bg_color</span><span class="s0">, </span><span class="s2">&quot;bpp = %i&quot; </span><span class="s1">% (bpp</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_set_pixel(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s1">ar.__getitem__(</span><span class="s5">0</span><span class="s1">).__setitem__(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>

            <span class="s1">ar.__getitem__(</span><span class="s5">1</span><span class="s1">).__setitem__(</span><span class="s5">1</span><span class="s0">, </span><span class="s1">(</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">)))</span>

            <span class="s1">ar.__getitem__(-</span><span class="s5">1</span><span class="s1">).__setitem__(-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">(</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">9</span><span class="s1">][</span><span class="s5">19</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">)))</span>

            <span class="s1">ar.__getitem__(-</span><span class="s5">2</span><span class="s1">).__setitem__(-</span><span class="s5">2</span><span class="s0">, </span><span class="s1">(</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">8</span><span class="s1">][-</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">)))</span>

    <span class="s0">def </span><span class="s1">test_set_column(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">6</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s1">sf2 = pygame.Surface((</span><span class="s5">6</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf2.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">ar2 = pygame.PixelArray(sf2)</span>

            <span class="s4"># Test single value assignment</span>
            <span class="s1">ar.__setitem__(</span><span class="s5">2</span><span class="s0">, </span><span class="s1">(</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">)))</span>

            <span class="s1">ar.__setitem__(-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">5</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>

            <span class="s1">ar.__setitem__(-</span><span class="s5">2</span><span class="s0">, </span><span class="s1">(</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">2</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>

            <span class="s4"># Test list assignment.</span>
            <span class="s1">ar.__setitem__(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">[(</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)] * </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>

            <span class="s4"># Test tuple assignment.</span>
            <span class="s4"># Changed in Pygame 1.9.2 - Raises an exception.</span>
            <span class="s1">self.assertRaises(</span>
                <span class="s1">ValueError</span><span class="s0">,</span>
                <span class="s1">ar.__setitem__</span><span class="s0">,</span>
                <span class="s5">1</span><span class="s0">,</span>
                <span class="s1">(</span>
                    <span class="s1">(</span><span class="s5">204</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">204</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s5">204</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">204</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s5">204</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">204</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s5">204</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">204</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s0">, </span><span class="s5">17</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>

            <span class="s4"># Test pixel array assignment.</span>
            <span class="s1">ar.__setitem__(</span><span class="s5">1</span><span class="s0">, </span><span class="s1">ar2.__getitem__(</span><span class="s5">3</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>

    <span class="s0">def </span><span class="s1">test_get_slice(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s1">self.assertEqual(len(ar[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s1">])</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(len(ar[</span><span class="s5">3</span><span class="s1">:</span><span class="s5">7</span><span class="s1">][</span><span class="s5">3</span><span class="s1">])</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span>

            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">5</span><span class="s1">:</span><span class="s5">5</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">9</span><span class="s1">:</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>

            <span class="s4"># Has to resolve to ar[7:8]</span>
            <span class="s1">self.assertEqual(len(ar[-</span><span class="s5">3</span><span class="s1">:-</span><span class="s5">2</span><span class="s1">])</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)  </span><span class="s4"># 2D</span>
            <span class="s1">self.assertEqual(len(ar[-</span><span class="s5">3</span><span class="s1">:-</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)  </span><span class="s4"># 1D</span>

            <span class="s4"># Try assignments.</span>

            <span class="s4"># 2D assignment.</span>
            <span class="s1">ar[</span><span class="s5">2</span><span class="s1">:</span><span class="s5">5</span><span class="s1">] = (</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>

            <span class="s4"># 1D assignment</span>
            <span class="s1">ar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">3</span><span class="s1">:</span><span class="s5">7</span><span class="s1">] = (</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)))</span>

    <span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;skipping for PyPy (segfaults on mac pypy3 6.0.0)&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_contains(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">sf.set_at((</span><span class="s5">8</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>

            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">self.assertTrue((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">) </span><span class="s0">in </span><span class="s1">ar)</span>
            <span class="s1">self.assertTrue((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">) </span><span class="s0">in </span><span class="s1">ar)</span>
            <span class="s1">self.assertFalse((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">) </span><span class="s0">in </span><span class="s1">ar)</span>
            <span class="s1">self.assertFalse(</span><span class="s5">0x0000FF </span><span class="s0">in </span><span class="s1">ar)</span>

            <span class="s4"># Test sliced array</span>
            <span class="s1">self.assertTrue((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">) </span><span class="s0">in </span><span class="s1">ar[</span><span class="s5">8</span><span class="s1">])</span>
            <span class="s1">self.assertTrue((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">) </span><span class="s0">in </span><span class="s1">ar[</span><span class="s5">8</span><span class="s1">])</span>
            <span class="s1">self.assertFalse((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">) </span><span class="s0">in </span><span class="s1">ar[</span><span class="s5">8</span><span class="s1">])</span>
            <span class="s1">self.assertFalse(</span><span class="s5">0x0000FF </span><span class="s0">in </span><span class="s1">ar[</span><span class="s5">8</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_get_surface(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">self.assertTrue(ar.surface </span><span class="s0">is </span><span class="s1">sf)</span>

    <span class="s0">def </span><span class="s1">test_get_surface__subclassed_surface(self):</span>
        <span class="s3">&quot;&quot;&quot;Ensure the surface attribute can handle subclassed surfaces.&quot;&quot;&quot;</span>
        <span class="s1">expected_surface = SurfaceSubclass((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">pixelarray = pygame.PixelArray(expected_surface)</span>

        <span class="s1">surface = pixelarray.surface</span>

        <span class="s1">self.assertIs(surface</span><span class="s0">, </span><span class="s1">expected_surface)</span>
        <span class="s1">self.assertIsInstance(surface</span><span class="s0">, </span><span class="s1">pygame.Surface)</span>
        <span class="s1">self.assertIsInstance(surface</span><span class="s0">, </span><span class="s1">SurfaceSubclass)</span>

    <span class="s0">def </span><span class="s1">test_set_slice(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">6</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s4"># Test single value assignment</span>
            <span class="s1">val = sf.map_rgb((</span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
            <span class="s1">ar[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = val</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>

            <span class="s1">val = sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">ar[-</span><span class="s5">3</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">] = val</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">2</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>

            <span class="s1">val = sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">ar[-</span><span class="s5">3</span><span class="s1">:] = (</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>

            <span class="s4"># Test array size mismatch.</span>
            <span class="s4"># Changed in ver. 1.9.2</span>
            <span class="s4"># (was &quot;Test list assignment, this is a vertical assignment.&quot;)</span>
            <span class="s1">val = sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">ar.__setitem__</span><span class="s0">, </span><span class="s1">slice(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[val] * </span><span class="s5">8</span><span class="s1">)</span>

            <span class="s4"># And the horizontal assignment.</span>
            <span class="s1">val = sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">val2 = sf.map_rgb((</span><span class="s5">128</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">ar[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = [val</span><span class="s0">, </span><span class="s1">val2]</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val2)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val2)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val2)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val2)</span>

            <span class="s4"># Test pixelarray assignment.</span>
            <span class="s1">ar[:] = (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">sf2 = pygame.Surface((</span><span class="s5">6</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf2.fill((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>

            <span class="s1">val = sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">ar2 = pygame.PixelArray(sf2)</span>

            <span class="s1">ar[:] = ar2[:]</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">5</span><span class="s1">][</span><span class="s5">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>

            <span class="s4"># Ensure p1 ... pn are freed for array[...] = [p1, ..., pn]</span>
            <span class="s4"># Bug fix: reference counting.</span>
            <span class="s0">if </span><span class="s1">hasattr(sys</span><span class="s0">, </span><span class="s2">&quot;getrefcount&quot;</span><span class="s1">):</span>

                <span class="s0">class </span><span class="s1">Int(int):</span>
                    <span class="s3">&quot;&quot;&quot;Unique int instances&quot;&quot;&quot;</span>

                    <span class="s0">pass</span>

                <span class="s1">sf = pygame.Surface((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
                <span class="s1">ar = pygame.PixelArray(sf)</span>
                <span class="s1">pixel_list = [Int(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(ar.shape[</span><span class="s5">0</span><span class="s1">])]</span>
                <span class="s1">refcnts_before = [sys.getrefcount(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">pixel_list]</span>
                <span class="s1">ar[...] = pixel_list</span>
                <span class="s1">refcnts_after = [sys.getrefcount(i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">pixel_list]</span>
                <span class="s1">gc.collect()</span>
                <span class="s1">self.assertEqual(refcnts_after</span><span class="s0">, </span><span class="s1">refcnts_before)</span>

    <span class="s0">def </span><span class="s1">test_subscript(self):</span>
        <span class="s4"># By default we do not need to work with any special __***__</span>
        <span class="s4"># methods as map subscripts are the first looked up by the</span>
        <span class="s4"># object system.</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">6</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.set_at((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">sf.set_at((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">sf.set_at((</span><span class="s5">4</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">val = sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>

            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s4"># Test single value requests.</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">][</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">val)</span>

            <span class="s4"># Test ellipse working.</span>
            <span class="s1">self.assertEqual(len(ar[...</span><span class="s0">, </span><span class="s1">...])</span><span class="s0">, </span><span class="s5">6</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(len(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s1">...])</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(len(ar[...</span><span class="s0">, </span><span class="s5">3</span><span class="s1">])</span><span class="s0">, </span><span class="s5">6</span><span class="s1">)</span>

            <span class="s4"># Test simple slicing</span>
            <span class="s1">self.assertEqual(len(ar[:</span><span class="s0">, </span><span class="s1">:])</span><span class="s0">, </span><span class="s5">6</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">len(</span>
                    <span class="s1">ar[</span>
                        <span class="s1">:</span><span class="s0">,</span>
                    <span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s5">6</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">self.assertEqual(len(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s1">:])</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(len(ar[:</span><span class="s0">, </span><span class="s5">2</span><span class="s1">])</span><span class="s0">, </span><span class="s5">6</span><span class="s1">)</span>
            <span class="s4"># Empty slices</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar[</span>
                    <span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s0">None,</span>
            <span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s0">, </span><span class="s1">...]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s0">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s0">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar[</span>
                    <span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:</span><span class="s5">2</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s0">None,</span>
            <span class="s1">)</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar[</span>
                    <span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:-</span><span class="s5">2</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s0">None,</span>
            <span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:</span><span class="s5">1</span><span class="s0">, </span><span class="s1">...]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">...]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[...</span><span class="s0">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">4</span><span class="s0">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[...</span><span class="s0">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[...</span><span class="s0">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">4</span><span class="s0">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">4</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span>

            <span class="s4"># Test advanced slicing</span>
            <span class="s1">ar[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">0</span>
            <span class="s1">ar[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1</span>
            <span class="s1">ar[</span><span class="s5">2</span><span class="s1">] = </span><span class="s5">2</span>
            <span class="s1">ar[</span><span class="s5">3</span><span class="s1">] = </span><span class="s5">3</span>
            <span class="s1">ar[</span><span class="s5">4</span><span class="s1">] = </span><span class="s5">4</span>
            <span class="s1">ar[</span><span class="s5">5</span><span class="s1">] = </span><span class="s5">5</span>

            <span class="s4"># We should receive something like [0,2,4]</span>
            <span class="s1">self.assertEqual(ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s4"># We should receive something like [2,2,2]</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>

            <span class="s4"># Should create a 3x3 array of [0,2,4]</span>
            <span class="s1">ar2 = ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(len(ar2)</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>

            <span class="s4"># Should create a reversed 3x8 array over X of [1,2,3] -&gt; [3,2,1]</span>
            <span class="s1">ar2 = ar[</span><span class="s5">3</span><span class="s1">:</span><span class="s5">0</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(len(ar2)</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">7</span><span class="s1">]</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">7</span><span class="s1">]</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s4"># Should completely reverse the array over X -&gt; [5,4,3,2,1,0]</span>
            <span class="s1">ar2 = ar[::-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(len(ar2)</span><span class="s0">, </span><span class="s5">6</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">][-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">1</span><span class="s1">][-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[-</span><span class="s5">1</span><span class="s1">][-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[-</span><span class="s5">2</span><span class="s1">][-</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[-</span><span class="s5">3</span><span class="s1">][-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>

            <span class="s4"># Test advanced slicing</span>
            <span class="s1">ar[:] = </span><span class="s5">0</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">ar2[:] = [</span><span class="s5">99</span><span class="s1">] * len(ar2)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[-</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2[</span><span class="s5">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">99</span><span class="s1">)</span>

            <span class="s4"># Cases where a 2d array should have a dimension of length 1.</span>
            <span class="s1">ar2 = ar[</span><span class="s5">1</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s1">ar.shape[</span><span class="s5">1</span><span class="s1">]))</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">2</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">(ar.shape[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">1</span><span class="s1">))</span>
            <span class="s1">sf2 = pygame.Surface((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
            <span class="s1">ar2 = pygame.PixelArray(sf2)</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">sf2.get_size())</span>
            <span class="s1">sf2 = pygame.Surface((</span><span class="s5">7</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
            <span class="s1">ar2 = pygame.PixelArray(sf2)</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">sf2.get_size())</span>

            <span class="s4"># Array has a single ellipsis subscript: the identity operator</span>
            <span class="s1">ar2 = ar[...]</span>
            <span class="s1">self.assertTrue(ar2 </span><span class="s0">is </span><span class="s1">ar)</span>

            <span class="s4"># Ensure x and y are freed for p = array[x, y]</span>
            <span class="s4"># Bug fix: reference counting</span>
            <span class="s0">if </span><span class="s1">hasattr(sys</span><span class="s0">, </span><span class="s2">&quot;getrefcount&quot;</span><span class="s1">):</span>

                <span class="s0">class </span><span class="s1">Int(int):</span>
                    <span class="s3">&quot;&quot;&quot;Unique int instances&quot;&quot;&quot;</span>

                    <span class="s0">pass</span>

                <span class="s1">sf = pygame.Surface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
                <span class="s1">ar = pygame.PixelArray(sf)</span>
                <span class="s1">x</span><span class="s0">, </span><span class="s1">y = Int(</span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Int(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">rx_before</span><span class="s0">, </span><span class="s1">ry_before = sys.getrefcount(x)</span><span class="s0">, </span><span class="s1">sys.getrefcount(y)</span>
                <span class="s1">p = ar[x</span><span class="s0">, </span><span class="s1">y]</span>
                <span class="s1">rx_after</span><span class="s0">, </span><span class="s1">ry_after = sys.getrefcount(x)</span><span class="s0">, </span><span class="s1">sys.getrefcount(y)</span>
                <span class="s1">self.assertEqual(rx_after</span><span class="s0">, </span><span class="s1">rx_before)</span>
                <span class="s1">self.assertEqual(ry_after</span><span class="s0">, </span><span class="s1">ry_before)</span>

    <span class="s0">def </span><span class="s1">test_ass_subscript(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">6</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>

            <span class="s4"># Test ellipse working</span>
            <span class="s1">ar[...</span><span class="s0">, </span><span class="s1">...] = (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">ar[</span>
                <span class="s1">...</span><span class="s0">,</span>
            <span class="s1">] = (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)))</span>
            <span class="s1">ar[:</span><span class="s0">, </span><span class="s1">...] = (</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>
            <span class="s1">ar[...] = (</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>
            <span class="s1">self.assertEqual(ar[-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)))</span>

            <span class="s4"># Ensure x and y are freed for array[x, y] = p</span>
            <span class="s4"># Bug fix: reference counting</span>
            <span class="s0">if </span><span class="s1">hasattr(sys</span><span class="s0">, </span><span class="s2">&quot;getrefcount&quot;</span><span class="s1">):</span>

                <span class="s0">class </span><span class="s1">Int(int):</span>
                    <span class="s3">&quot;&quot;&quot;Unique int instances&quot;&quot;&quot;</span>

                    <span class="s0">pass</span>

                <span class="s1">sf = pygame.Surface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
                <span class="s1">ar = pygame.PixelArray(sf)</span>
                <span class="s1">x</span><span class="s0">, </span><span class="s1">y = Int(</span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Int(</span><span class="s5">1</span><span class="s1">)</span>
                <span class="s1">rx_before</span><span class="s0">, </span><span class="s1">ry_before = sys.getrefcount(x)</span><span class="s0">, </span><span class="s1">sys.getrefcount(y)</span>
                <span class="s1">ar[x</span><span class="s0">, </span><span class="s1">y] = </span><span class="s5">0</span>
                <span class="s1">rx_after</span><span class="s0">, </span><span class="s1">ry_after = sys.getrefcount(x)</span><span class="s0">, </span><span class="s1">sys.getrefcount(y)</span>
                <span class="s1">self.assertEqual(rx_after</span><span class="s0">, </span><span class="s1">rx_before)</span>
                <span class="s1">self.assertEqual(ry_after</span><span class="s0">, </span><span class="s1">ry_before)</span>

    <span class="s0">def </span><span class="s1">test_pixels_field(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]:</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">11</span><span class="s0">, </span><span class="s5">7</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp * </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">ar2 = ar[</span><span class="s5">1</span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">self.assertEqual(ar2._pixels_address - ar._pixels_address</span><span class="s0">, </span><span class="s1">ar.itemsize)</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s5">1</span><span class="s1">:]</span>
            <span class="s1">self.assertEqual(ar2._pixels_address - ar._pixels_address</span><span class="s0">, </span><span class="s1">ar.strides[</span><span class="s5">1</span><span class="s1">])</span>
            <span class="s1">ar2 = ar[::-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">,</span>
                <span class="s1">(ar.shape[</span><span class="s5">0</span><span class="s1">] - </span><span class="s5">1</span><span class="s1">) * ar.itemsize</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar2 = ar[::-</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">,</span>
                <span class="s1">(ar.shape[</span><span class="s5">0</span><span class="s1">] - </span><span class="s5">1</span><span class="s1">) * ar.itemsize</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">,</span>
                <span class="s1">(ar.shape[</span><span class="s5">1</span><span class="s1">] - </span><span class="s5">1</span><span class="s1">) * ar.strides[</span><span class="s5">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar3 = ar2[::-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar3._pixels_address - ar._pixels_address</span><span class="s0">,</span>
                <span class="s1">(ar.shape[</span><span class="s5">0</span><span class="s1">] - </span><span class="s5">1</span><span class="s1">) * ar.strides[</span><span class="s5">0</span><span class="s1">] + (ar.shape[</span><span class="s5">1</span><span class="s1">] - </span><span class="s5">1</span><span class="s1">) * ar.strides[</span><span class="s5">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s5">2</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">,</span>
                <span class="s1">(ar.shape[</span><span class="s5">1</span><span class="s1">] - </span><span class="s5">1</span><span class="s1">) * ar.strides[</span><span class="s5">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar2 = ar[</span><span class="s5">2</span><span class="s1">::</span><span class="s0">, </span><span class="s5">3</span><span class="s1">::]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">,</span>
                <span class="s1">ar.strides[</span><span class="s5">0</span><span class="s1">] * </span><span class="s5">2 </span><span class="s1">+ ar.strides[</span><span class="s5">1</span><span class="s1">] * </span><span class="s5">3</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar2 = ar[</span><span class="s5">2</span><span class="s1">::</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">::</span><span class="s5">4</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">,</span>
                <span class="s1">ar.strides[</span><span class="s5">0</span><span class="s1">] * </span><span class="s5">2 </span><span class="s1">+ ar.strides[</span><span class="s5">1</span><span class="s1">] * </span><span class="s5">3</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar2 = ar[</span><span class="s5">9</span><span class="s1">:</span><span class="s5">2</span><span class="s1">:-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">, </span><span class="s1">ar.strides[</span><span class="s5">0</span><span class="s1">] * </span><span class="s5">9</span>
            <span class="s1">)</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s5">5</span><span class="s1">:</span><span class="s5">2</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">ar2._pixels_address - ar._pixels_address</span><span class="s0">, </span><span class="s1">ar.strides[</span><span class="s5">1</span><span class="s1">] * </span><span class="s5">5</span>
            <span class="s1">)</span>
            <span class="s4">##? ar2 = ar[:,9:2:-1]</span>

    <span class="s0">def </span><span class="s1">test_make_surface(self):</span>
        <span class="s1">bg_color = pygame.Color(</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span>
        <span class="s1">fg_color = pygame.Color(</span><span class="s5">128</span><span class="s0">, </span><span class="s5">100</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">bg_color_adj = sf.unmap_rgb(sf.map_rgb(bg_color))</span>
            <span class="s1">fg_color_adj = sf.unmap_rgb(sf.map_rgb(fg_color))</span>
            <span class="s1">sf.fill(bg_color_adj)</span>
            <span class="s1">sf.fill(fg_color_adj</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">11</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">newsf = ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">].make_surface()</span>
            <span class="s1">rect = newsf.get_rect()</span>
            <span class="s1">self.assertEqual(rect.width</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(rect.height</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span>
            <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">[</span>
                <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">7</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">7</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]:</span>
                <span class="s1">self.assertEqual(newsf.get_at(p)</span><span class="s0">, </span><span class="s1">bg_color_adj)</span>
            <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">[(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">7</span><span class="s1">)]:</span>
                <span class="s1">self.assertEqual(newsf.get_at(p)</span><span class="s0">, </span><span class="s1">fg_color_adj)</span>

        <span class="s4"># Bug when array width is not a multiple of the slice step.</span>
        <span class="s1">w = </span><span class="s5">17</span>
        <span class="s1">lst = list(range(w))</span>
        <span class="s1">w_slice = len(lst[::</span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">h = </span><span class="s5">3</span>
        <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">ar2 = ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">sf2 = ar2.make_surface()</span>
        <span class="s1">w2</span><span class="s0">, </span><span class="s1">h2 = sf2.get_size()</span>
        <span class="s1">self.assertEqual(w2</span><span class="s0">, </span><span class="s1">w_slice)</span>
        <span class="s1">self.assertEqual(h2</span><span class="s0">, </span><span class="s1">h)</span>

        <span class="s4"># Bug when array height is not a multiple of the slice step.</span>
        <span class="s4"># This can hang the Python interpreter.</span>
        <span class="s1">h = </span><span class="s5">17</span>
        <span class="s1">lst = list(range(h))</span>
        <span class="s1">h_slice = len(lst[::</span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">w = </span><span class="s5">3</span>
        <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">]</span>
        <span class="s1">sf2 = ar2.make_surface()  </span><span class="s4"># Hangs here.</span>
        <span class="s1">w2</span><span class="s0">, </span><span class="s1">h2 = sf2.get_size()</span>
        <span class="s1">self.assertEqual(w2</span><span class="s0">, </span><span class="s1">w)</span>
        <span class="s1">self.assertEqual(h2</span><span class="s0">, </span><span class="s1">h_slice)</span>

    <span class="s0">def </span><span class="s1">test_make_surface__subclassed_surface(self):</span>
        <span class="s3">&quot;&quot;&quot;Ensure make_surface can handle subclassed surfaces.&quot;&quot;&quot;</span>
        <span class="s1">expected_size = (</span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">expected_flags = </span><span class="s5">0</span>
        <span class="s1">expected_depth = </span><span class="s5">32</span>
        <span class="s1">original_surface = SurfaceSubclass(</span>
            <span class="s1">expected_size</span><span class="s0">, </span><span class="s1">expected_flags</span><span class="s0">, </span><span class="s1">expected_depth</span>
        <span class="s1">)</span>
        <span class="s1">pixelarray = pygame.PixelArray(original_surface)</span>

        <span class="s1">surface = pixelarray.make_surface()</span>

        <span class="s1">self.assertIsNot(surface</span><span class="s0">, </span><span class="s1">original_surface)</span>
        <span class="s1">self.assertIsInstance(surface</span><span class="s0">, </span><span class="s1">pygame.Surface)</span>
        <span class="s1">self.assertNotIsInstance(surface</span><span class="s0">, </span><span class="s1">SurfaceSubclass)</span>
        <span class="s1">self.assertEqual(surface.get_size()</span><span class="s0">, </span><span class="s1">expected_size)</span>
        <span class="s1">self.assertEqual(surface.get_flags()</span><span class="s0">, </span><span class="s1">expected_flags)</span>
        <span class="s1">self.assertEqual(surface.get_bitsize()</span><span class="s0">, </span><span class="s1">expected_depth)</span>

    <span class="s0">def </span><span class="s1">test_iter(self):</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">iterations = </span><span class="s5">0</span>
            <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">ar:</span>
                <span class="s1">self.assertEqual(len(col)</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span>
                <span class="s1">iterations += </span><span class="s5">1</span>
            <span class="s1">self.assertEqual(iterations</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_replace(self):</span>
        <span class="s4"># print(&quot;replace start&quot;)</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">rval = sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">oval = sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">ar[::</span><span class="s5">2</span><span class="s1">].replace((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">8</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">9</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>

            <span class="s1">ar[::</span><span class="s5">2</span><span class="s1">].replace((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">weights=(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">20</span><span class="s0">, </span><span class="s5">50</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">8</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>
            <span class="s1">self.assertEqual(ar[</span><span class="s5">9</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">oval)</span>
        <span class="s4"># print(&quot;replace end&quot;)</span>

    <span class="s0">def </span><span class="s1">test_extract(self):</span>
        <span class="s4"># print(&quot;extract start&quot;)</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">(</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">):</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">10</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp)</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">sf.fill((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">6</span><span class="s1">))</span>

            <span class="s1">white = sf.map_rgb((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s0">, </span><span class="s5">255</span><span class="s1">))</span>
            <span class="s1">black = sf.map_rgb((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>

            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">newar = ar.extract((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>

            <span class="s1">self.assertEqual(newar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">white)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">white)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">8</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">9</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>

            <span class="s1">newar = ar.extract((</span><span class="s5">255</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">weights=(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">0.1</span><span class="s0">, </span><span class="s5">50</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">white)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">white)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">8</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>
            <span class="s1">self.assertEqual(newar[</span><span class="s5">9</span><span class="s1">][</span><span class="s5">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">black)</span>
        <span class="s4"># print(&quot;extract end&quot;)</span>

    <span class="s0">def </span><span class="s1">test_2dslice_assignment(self):</span>
        <span class="s1">w = </span><span class="s5">2 </span><span class="s1">* </span><span class="s5">5 </span><span class="s1">* </span><span class="s5">8</span>
        <span class="s1">h = </span><span class="s5">3 </span><span class="s1">* </span><span class="s5">5 </span><span class="s1">* </span><span class="s5">9</span>
        <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">size = (w</span><span class="s0">, </span><span class="s1">h)</span>
        <span class="s1">strides = (</span><span class="s5">1</span><span class="s0">, </span><span class="s1">w)</span>
        <span class="s1">offset = </span><span class="s5">0</span>
        <span class="s1">self._test_assignment(sf</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset)</span>
        <span class="s1">xslice = slice(</span><span class="s0">None, None, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">yslice = slice(</span><span class="s0">None, None, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset = self._array_slice(</span>
            <span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">(xslice</span><span class="s0">, </span><span class="s1">yslice)</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset</span>
        <span class="s1">)</span>
        <span class="s1">self._test_assignment(sf</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset)</span>
        <span class="s1">xslice = slice(</span><span class="s5">5</span><span class="s0">, None, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">yslice = slice(</span><span class="s5">5</span><span class="s0">, None, </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset = self._array_slice(</span>
            <span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">(xslice</span><span class="s0">, </span><span class="s1">yslice)</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset</span>
        <span class="s1">)</span>
        <span class="s1">self._test_assignment(sf</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset)</span>

    <span class="s0">def </span><span class="s1">_test_assignment(self</span><span class="s0">, </span><span class="s1">sf</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">ar_size</span><span class="s0">, </span><span class="s1">ar_strides</span><span class="s0">, </span><span class="s1">ar_offset):</span>
        <span class="s1">self.assertEqual(ar.shape</span><span class="s0">, </span><span class="s1">ar_size)</span>
        <span class="s1">ar_w</span><span class="s0">, </span><span class="s1">ar_h = ar_size</span>
        <span class="s1">ar_xstride</span><span class="s0">, </span><span class="s1">ar_ystride = ar_strides</span>
        <span class="s1">sf_w</span><span class="s0">, </span><span class="s1">sf_h = sf.get_size()</span>
        <span class="s1">black = pygame.Color(</span><span class="s2">&quot;black&quot;</span><span class="s1">)</span>
        <span class="s1">color = pygame.Color(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">12</span><span class="s1">)</span>
        <span class="s1">pxcolor = sf.map_rgb(color)</span>
        <span class="s1">sf.fill(black)</span>
        <span class="s0">for </span><span class="s1">ar_x</span><span class="s0">, </span><span class="s1">ar_y </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">ar_h - </span><span class="s5">4</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(ar_w - </span><span class="s5">3</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">ar_h - </span><span class="s5">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(ar_w - </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(ar_w - </span><span class="s5">1</span><span class="s0">, </span><span class="s1">ar_h - </span><span class="s5">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]:</span>
            <span class="s1">sf_offset = ar_offset + ar_x * ar_xstride + ar_y * ar_ystride</span>
            <span class="s1">sf_y = sf_offset // sf_w</span>
            <span class="s1">sf_x = sf_offset - sf_y * sf_w</span>
            <span class="s1">sf_posn = (sf_x</span><span class="s0">, </span><span class="s1">sf_y)</span>
            <span class="s1">sf_pix = sf.get_at(sf_posn)</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">sf_pix</span><span class="s0">,</span>
                <span class="s1">black</span><span class="s0">,</span>
                <span class="s2">&quot;at pixarr posn (%i, %i) (surf posn (%i, %i)): &quot;</span>
                <span class="s2">&quot;%s != %s&quot; </span><span class="s1">% (ar_x</span><span class="s0">, </span><span class="s1">ar_y</span><span class="s0">, </span><span class="s1">sf_x</span><span class="s0">, </span><span class="s1">sf_y</span><span class="s0">, </span><span class="s1">sf_pix</span><span class="s0">, </span><span class="s1">black)</span><span class="s0">,</span>
            <span class="s1">)</span>
            <span class="s1">ar[ar_x</span><span class="s0">, </span><span class="s1">ar_y] = pxcolor</span>
            <span class="s1">sf_pix = sf.get_at(sf_posn)</span>
            <span class="s1">self.assertEqual(</span>
                <span class="s1">sf_pix</span><span class="s0">,</span>
                <span class="s1">color</span><span class="s0">,</span>
                <span class="s2">&quot;at pixarr posn (%i, %i) (surf posn (%i, %i)): &quot;</span>
                <span class="s2">&quot;%s != %s&quot; </span><span class="s1">% (ar_x</span><span class="s0">, </span><span class="s1">ar_y</span><span class="s0">, </span><span class="s1">sf_x</span><span class="s0">, </span><span class="s1">sf_y</span><span class="s0">, </span><span class="s1">sf_pix</span><span class="s0">, </span><span class="s1">color)</span><span class="s0">,</span>
            <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">_array_slice(self</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">size</span><span class="s0">, </span><span class="s1">slices</span><span class="s0">, </span><span class="s1">strides</span><span class="s0">, </span><span class="s1">offset):</span>
        <span class="s1">ar = ar[slices]</span>
        <span class="s1">xslice</span><span class="s0">, </span><span class="s1">yslice = slices</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = size</span>
        <span class="s1">xstart</span><span class="s0">, </span><span class="s1">xstop</span><span class="s0">, </span><span class="s1">xstep = xslice.indices(w)</span>
        <span class="s1">ystart</span><span class="s0">, </span><span class="s1">ystop</span><span class="s0">, </span><span class="s1">ystep = yslice.indices(h)</span>
        <span class="s1">w = (xstop - xstart + xstep - </span><span class="s5">1</span><span class="s1">) // xstep</span>
        <span class="s1">h = (ystop - ystart + ystep - </span><span class="s5">1</span><span class="s1">) // ystep</span>
        <span class="s1">xstride</span><span class="s0">, </span><span class="s1">ystride = strides</span>
        <span class="s1">offset += xstart * xstride + ystart * ystride</span>
        <span class="s1">xstride *= xstep</span>
        <span class="s1">ystride *= ystep</span>
        <span class="s0">return </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">(w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s1">(xstride</span><span class="s0">, </span><span class="s1">ystride)</span><span class="s0">, </span><span class="s1">offset</span>

    <span class="s0">def </span><span class="s1">test_array_properties(self):</span>
        <span class="s4"># itemsize, ndim, shape, and strides.</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]:</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp * </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">self.assertEqual(ar.itemsize</span><span class="s0">, </span><span class="s1">bpp)</span>

        <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s5">13</span><span class="s1">)]:</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">h = shape</span>
            <span class="s1">sf = pygame.Surface(shape</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
            <span class="s1">bpp = sf.get_bytesize()</span>
            <span class="s1">pitch = sf.get_pitch()</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">self.assertEqual(ar.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar.shape</span><span class="s0">, </span><span class="s1">shape)</span>
            <span class="s1">self.assertEqual(ar.strides</span><span class="s0">, </span><span class="s1">(bpp</span><span class="s0">, </span><span class="s1">pitch))</span>
            <span class="s1">ar2 = ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">w2 = len(([</span><span class="s5">0</span><span class="s1">] * w)[::</span><span class="s5">2</span><span class="s1">])</span>
            <span class="s1">self.assertEqual(ar2.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">(w2</span><span class="s0">, </span><span class="s1">h))</span>
            <span class="s1">self.assertEqual(ar2.strides</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2 </span><span class="s1">* bpp</span><span class="s0">, </span><span class="s1">pitch))</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">]</span>
            <span class="s1">h2 = len(([</span><span class="s5">0</span><span class="s1">] * h)[::</span><span class="s5">2</span><span class="s1">])</span>
            <span class="s1">self.assertEqual(ar2.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">(w</span><span class="s0">, </span><span class="s1">h2))</span>
            <span class="s1">self.assertEqual(ar2.strides</span><span class="s0">, </span><span class="s1">(bpp</span><span class="s0">, </span><span class="s5">2 </span><span class="s1">* pitch))</span>
            <span class="s1">ar2 = ar[</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(ar2.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">(h</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar2.strides</span><span class="s0">, </span><span class="s1">(pitch</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span>
            <span class="s1">self.assertEqual(ar2.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(ar2.shape</span><span class="s0">, </span><span class="s1">(w</span><span class="s0">,</span><span class="s1">))</span>
            <span class="s1">self.assertEqual(ar2.strides</span><span class="s0">, </span><span class="s1">(bpp</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_self_assign(self):</span>
        <span class="s4"># This differs from NumPy arrays.</span>
        <span class="s1">w = </span><span class="s5">10</span>
        <span class="s1">max_x = w - </span><span class="s5">1</span>
        <span class="s1">h = </span><span class="s5">20</span>
        <span class="s1">max_y = h - </span><span class="s5">1</span>
        <span class="s0">for </span><span class="s1">bpp </span><span class="s0">in </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">]:</span>
            <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bpp * </span><span class="s5">8</span><span class="s1">)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
                <span class="s1">ar[i % w</span><span class="s0">, </span><span class="s1">i // w] = i</span>
            <span class="s1">ar[:</span><span class="s0">, </span><span class="s1">:] = ar[::-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
                <span class="s1">self.assertEqual(ar[max_x - i % w</span><span class="s0">, </span><span class="s1">i // w]</span><span class="s0">, </span><span class="s1">i)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
                <span class="s1">ar[i % w</span><span class="s0">, </span><span class="s1">i // w] = i</span>
            <span class="s1">ar[:</span><span class="s0">, </span><span class="s1">:] = ar[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
                <span class="s1">self.assertEqual(ar[i % w</span><span class="s0">, </span><span class="s1">max_y - i // w]</span><span class="s0">, </span><span class="s1">i)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
                <span class="s1">ar[i % w</span><span class="s0">, </span><span class="s1">i // w] = i</span>
            <span class="s1">ar[:</span><span class="s0">, </span><span class="s1">:] = ar[::-</span><span class="s5">1</span><span class="s0">, </span><span class="s1">::-</span><span class="s5">1</span><span class="s1">]</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
                <span class="s1">self.assertEqual(ar[max_x - i % w</span><span class="s0">, </span><span class="s1">max_y - i // w]</span><span class="s0">, </span><span class="s1">i)</span>

    <span class="s0">def </span><span class="s1">test_color_value(self):</span>
        <span class="s4"># Confirm that a PixelArray slice assignment distinguishes between</span>
        <span class="s4"># pygame.Color and tuple objects as single (r, g, b[, a]) colors</span>
        <span class="s4"># and other sequences as sequences of colors to be treated as</span>
        <span class="s4"># slices.</span>
        <span class="s1">sf = pygame.Surface((</span><span class="s5">5</span><span class="s0">, </span><span class="s5">5</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">index = slice(</span><span class="s0">None, None, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">ar.__setitem__(index</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)))</span>
        <span class="s1">ar.__setitem__(index</span><span class="s0">, </span><span class="s1">pygame.Color(</span><span class="s5">10</span><span class="s0">, </span><span class="s5">11</span><span class="s0">, </span><span class="s5">12</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">11</span><span class="s0">, </span><span class="s5">12</span><span class="s1">)))</span>
        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">ar.__setitem__</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">ar.__setitem__</span><span class="s0">, </span><span class="s1">(index</span><span class="s0">, </span><span class="s1">index)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">ar.__setitem__</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">ar.__setitem__</span><span class="s0">, </span><span class="s1">(index</span><span class="s0">, </span><span class="s1">index)</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">])</span>
        <span class="s1">sf = pygame.Surface((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">ar[:] = (</span><span class="s5">20</span><span class="s0">, </span><span class="s5">30</span><span class="s0">, </span><span class="s5">40</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sf.map_rgb((</span><span class="s5">20</span><span class="s0">, </span><span class="s5">30</span><span class="s0">, </span><span class="s5">40</span><span class="s1">)))</span>
        <span class="s1">ar[:] = [</span><span class="s5">20</span><span class="s0">, </span><span class="s5">30</span><span class="s0">, </span><span class="s5">40</span><span class="s1">]</span>
        <span class="s1">self.assertEqual(ar[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">20</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(ar[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">30</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(ar[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s5">40</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_transpose(self):</span>
        <span class="s4"># PixelArray.transpose(): swap axis on a 2D array, add a length</span>
        <span class="s4"># 1 x axis to a 1D array.</span>
        <span class="s1">sf = pygame.Surface((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">7</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = ar.shape</span>
        <span class="s1">dx</span><span class="s0">, </span><span class="s1">dy = ar.strides</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
            <span class="s1">x = i % w</span>
            <span class="s1">y = i // w</span>
            <span class="s1">ar[x</span><span class="s0">, </span><span class="s1">y] = i</span>
        <span class="s1">ar_t = ar.transpose()</span>
        <span class="s1">self.assertEqual(ar_t.shape</span><span class="s0">, </span><span class="s1">(h</span><span class="s0">, </span><span class="s1">w))</span>
        <span class="s1">self.assertEqual(ar_t.strides</span><span class="s0">, </span><span class="s1">(dy</span><span class="s0">, </span><span class="s1">dx))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w * h):</span>
            <span class="s1">x = i % w</span>
            <span class="s1">y = i // w</span>
            <span class="s1">self.assertEqual(ar_t[y</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">ar[x</span><span class="s0">, </span><span class="s1">y])</span>
        <span class="s1">ar1D = ar[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">ar2D = ar1D.transpose()</span>
        <span class="s1">self.assertEqual(ar2D.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s1">h))</span>
        <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(h):</span>
            <span class="s1">self.assertEqual(ar1D[y]</span><span class="s0">, </span><span class="s1">ar2D[</span><span class="s5">0</span><span class="s0">, </span><span class="s1">y])</span>
        <span class="s1">ar1D = ar[:</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">ar2D = ar1D.transpose()</span>
        <span class="s1">self.assertEqual(ar2D.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s1">w))</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
            <span class="s1">self.assertEqual(ar1D[x]</span><span class="s0">, </span><span class="s1">ar2D[</span><span class="s5">0</span><span class="s0">, </span><span class="s1">x])</span>

    <span class="s0">def </span><span class="s1">test_length_1_dimension_broadcast(self):</span>
        <span class="s1">w = </span><span class="s5">5</span>
        <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">w)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s4"># y-axis broadcast.</span>
        <span class="s1">sf_x = pygame.Surface((w</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar_x = pygame.PixelArray(sf_x)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w):</span>
            <span class="s1">ar_x[i</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] = (w + </span><span class="s5">1</span><span class="s1">) * </span><span class="s5">10</span>
        <span class="s1">ar[...] = ar_x</span>
        <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(w):</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(w):</span>
                <span class="s1">self.assertEqual(ar[x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">ar_x[x</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s4"># x-axis broadcast.</span>
        <span class="s1">ar[...] = </span><span class="s5">0</span>
        <span class="s1">sf_y = pygame.Surface((</span><span class="s5">1</span><span class="s0">, </span><span class="s1">w)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar_y = pygame.PixelArray(sf_y)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(w):</span>
            <span class="s1">ar_y[</span><span class="s5">0</span><span class="s0">, </span><span class="s1">i] = (w + </span><span class="s5">1</span><span class="s1">) * </span><span class="s5">10</span>
        <span class="s1">ar[...] = ar_y</span>
        <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(w):</span>
            <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(w):</span>
                <span class="s1">self.assertEqual(ar[x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">ar_y[</span><span class="s5">0</span><span class="s0">, </span><span class="s1">y])</span>
        <span class="s4"># (1, 1) array broadcast.</span>
        <span class="s1">ar[...] = </span><span class="s5">0</span>
        <span class="s1">sf_1px = pygame.Surface((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar_1px = pygame.PixelArray(sf_1px)</span>
        <span class="s1">ar_1px[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">] = </span><span class="s5">42  </span><span class="s4"># Well it had to show up somewhere.</span>
        <span class="s1">ar[...] = ar_1px</span>
        <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">range(w):</span>
            <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(w):</span>
                <span class="s1">self.assertEqual(ar[x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s5">42</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_assign_size_mismatch(self):</span>
        <span class="s1">sf = pygame.Surface((</span><span class="s5">7</span><span class="s0">, </span><span class="s5">11</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">ar.__setitem__</span><span class="s0">, </span><span class="s1">Ellipsis</span><span class="s0">, </span><span class="s1">ar[:</span><span class="s0">, </span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">self.assertRaises(ValueError</span><span class="s0">, </span><span class="s1">ar.__setitem__</span><span class="s0">, </span><span class="s1">Ellipsis</span><span class="s0">, </span><span class="s1">ar[</span><span class="s5">0</span><span class="s1">:</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:])</span>

    <span class="s0">def </span><span class="s1">test_repr(self):</span>
        <span class="s4"># Python 3.x bug: the tp_repr slot function returned NULL instead</span>
        <span class="s4"># of a Unicode string, triggering an exception.</span>
        <span class="s1">sf = pygame.Surface((</span><span class="s5">3</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pygame.SRCALPHA</span><span class="s0">, </span><span class="s5">16</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s1">ar[...] = </span><span class="s5">42</span>
        <span class="s1">pixel = sf.get_at_mapped((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
        <span class="s1">self.assertEqual(repr(ar)</span><span class="s0">, </span><span class="s1">type(ar).__name__ + </span><span class="s2">&quot;([</span><span class="s0">\n  </span><span class="s2">[42, 42, 42]]</span><span class="s0">\n</span><span class="s2">)&quot;</span><span class="s1">)</span>


<span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;pypy having issues&quot;</span><span class="s1">)</span>
<span class="s0">class </span><span class="s1">PixelArrayArrayInterfaceTest(unittest.TestCase</span><span class="s0">, </span><span class="s1">TestMixin):</span>
    <span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;skipping for PyPy (why?)&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_basic(self):</span>
        <span class="s4"># Check unchanging fields.</span>
        <span class="s1">sf = pygame.Surface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>

        <span class="s1">ai = arrinter.ArrayInterface(ar)</span>
        <span class="s1">self.assertEqual(ai.two</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(ai.typekind</span><span class="s0">, </span><span class="s2">&quot;u&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(ai.nd</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(ai.data</span><span class="s0">, </span><span class="s1">ar._pixels_address)</span>

    <span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;skipping for PyPy (why?)&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_shape(self):</span>

        <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[[</span><span class="s5">4</span><span class="s0">, </span><span class="s5">16</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">5</span><span class="s0">, </span><span class="s5">13</span><span class="s1">]]:</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">h = shape</span>
            <span class="s1">sf = pygame.Surface(shape</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">ai = arrinter.ArrayInterface(ar)</span>
            <span class="s1">ai_shape = [ai.shape[i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(ai.nd)]</span>
            <span class="s1">self.assertEqual(ai_shape</span><span class="s0">, </span><span class="s1">shape)</span>
            <span class="s1">ar2 = ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">ai2 = arrinter.ArrayInterface(ar2)</span>
            <span class="s1">w2 = len(([</span><span class="s5">0</span><span class="s1">] * w)[::</span><span class="s5">2</span><span class="s1">])</span>
            <span class="s1">ai_shape = [ai2.shape[i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(ai2.nd)]</span>
            <span class="s1">self.assertEqual(ai_shape</span><span class="s0">, </span><span class="s1">[w2</span><span class="s0">, </span><span class="s1">h])</span>
            <span class="s1">ar2 = ar[:</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">]</span>
            <span class="s1">ai2 = arrinter.ArrayInterface(ar2)</span>
            <span class="s1">h2 = len(([</span><span class="s5">0</span><span class="s1">] * h)[::</span><span class="s5">2</span><span class="s1">])</span>
            <span class="s1">ai_shape = [ai2.shape[i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(ai2.nd)]</span>
            <span class="s1">self.assertEqual(ai_shape</span><span class="s0">, </span><span class="s1">[w</span><span class="s0">, </span><span class="s1">h2])</span>

    <span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;skipping for PyPy (why?)&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_itemsize(self):</span>
        <span class="s0">for </span><span class="s1">bytes_per_pixel </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">5</span><span class="s1">):</span>
            <span class="s1">bits_per_pixel = </span><span class="s5">8 </span><span class="s1">* bytes_per_pixel</span>
            <span class="s1">sf = pygame.Surface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bits_per_pixel)</span>
            <span class="s1">ar = pygame.PixelArray(sf)</span>
            <span class="s1">ai = arrinter.ArrayInterface(ar)</span>
            <span class="s1">self.assertEqual(ai.itemsize</span><span class="s0">, </span><span class="s1">bytes_per_pixel)</span>

    <span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;skipping for PyPy (why?)&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_flags(self):</span>
        <span class="s1">aim = arrinter</span>
        <span class="s1">common_flags = aim.PAI_NOTSWAPPED | aim.PAI_WRITEABLE | aim.PAI_ALIGNED</span>
        <span class="s1">s = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(s)</span>
        <span class="s1">ai = aim.ArrayInterface(ar)</span>
        <span class="s1">self.assertEqual(ai.flags</span><span class="s0">, </span><span class="s1">common_flags | aim.PAI_FORTRAN)</span>

        <span class="s1">ar2 = ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">ai = aim.ArrayInterface(ar2)</span>
        <span class="s1">self.assertEqual(ai.flags</span><span class="s0">, </span><span class="s1">common_flags)</span>

        <span class="s1">s = pygame.Surface((</span><span class="s5">8</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">24</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(s)</span>
        <span class="s1">ai = aim.ArrayInterface(ar)</span>
        <span class="s1">self.assertEqual(ai.flags</span><span class="s0">, </span><span class="s1">common_flags | aim.PAI_FORTRAN)</span>

        <span class="s1">s = pygame.Surface((</span><span class="s5">7</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">24</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(s)</span>
        <span class="s1">ai = aim.ArrayInterface(ar)</span>
        <span class="s1">self.assertEqual(ai.flags</span><span class="s0">, </span><span class="s1">common_flags)</span>

    <span class="s0">def </span><span class="s1">test_slicing(self):</span>
        <span class="s4"># This will implicitly test data and strides fields.</span>
        <span class="s4">#</span>
        <span class="s4"># Need an 8 bit test surfaces because pixelcopy.make_surface</span>
        <span class="s4"># returns an 8 bit surface for a 2d array.</span>

        <span class="s1">factors = [</span><span class="s5">7</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">11</span><span class="s1">]</span>

        <span class="s1">w = reduce(operator.mul</span><span class="s0">, </span><span class="s1">factors</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">h = </span><span class="s5">13</span>
        <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span>
        <span class="s1">color = sf.map_rgb((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">17</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">factors[:-</span><span class="s5">1</span><span class="s1">]:</span>
            <span class="s1">w = w // f</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = ar[f : f + w</span><span class="s0">, </span><span class="s1">:]</span>
            <span class="s1">ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] = color</span>
            <span class="s1">ar[-</span><span class="s5">1</span><span class="s1">][-</span><span class="s5">2</span><span class="s1">] = color</span>
            <span class="s1">ar[</span><span class="s5">0</span><span class="s1">][-</span><span class="s5">3</span><span class="s1">] = color</span>
            <span class="s1">sf2 = ar.make_surface()</span>
            <span class="s1">sf3 = pygame.pixelcopy.make_surface(ar)</span>
            <span class="s1">self.assert_surfaces_equal(sf3</span><span class="s0">, </span><span class="s1">sf2)</span>

        <span class="s1">h = reduce(operator.mul</span><span class="s0">, </span><span class="s1">factors</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">w = </span><span class="s5">13</span>
        <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span>
        <span class="s1">color = sf.map_rgb((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">17</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s0">for </span><span class="s1">f </span><span class="s0">in </span><span class="s1">factors[:-</span><span class="s5">1</span><span class="s1">]:</span>
            <span class="s1">h = h // f</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar = ar[:</span><span class="s0">, </span><span class="s1">f : f + h]</span>
            <span class="s1">ar[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] = color</span>
            <span class="s1">ar[-</span><span class="s5">1</span><span class="s1">][-</span><span class="s5">2</span><span class="s1">] = color</span>
            <span class="s1">ar[</span><span class="s5">0</span><span class="s1">][-</span><span class="s5">3</span><span class="s1">] = color</span>
            <span class="s1">sf2 = ar.make_surface()</span>
            <span class="s1">sf3 = pygame.pixelcopy.make_surface(ar)</span>
            <span class="s1">self.assert_surfaces_equal(sf3</span><span class="s0">, </span><span class="s1">sf2)</span>

        <span class="s1">w = </span><span class="s5">20</span>
        <span class="s1">h = </span><span class="s5">10</span>
        <span class="s1">sf = pygame.Surface((w</span><span class="s0">, </span><span class="s1">h)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">8</span><span class="s1">)</span>
        <span class="s1">color = sf.map_rgb((</span><span class="s5">1</span><span class="s0">, </span><span class="s5">17</span><span class="s0">, </span><span class="s5">128</span><span class="s1">))</span>
        <span class="s1">ar = pygame.PixelArray(sf)</span>
        <span class="s0">for </span><span class="s1">slices </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(slice(w)</span><span class="s0">, </span><span class="s1">slice(h))</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(h))</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(h))</span><span class="s0">,</span>
            <span class="s1">(slice(w)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">h</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(slice(w)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">h</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">h</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s0">, </span><span class="s1">h</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">]:</span>
            <span class="s1">sf.fill((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">))</span>
            <span class="s1">ar2 = ar[slices]</span>
            <span class="s1">ar2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] = color</span>
            <span class="s1">ar2[-</span><span class="s5">1</span><span class="s1">][-</span><span class="s5">2</span><span class="s1">] = color</span>
            <span class="s1">ar2[</span><span class="s5">0</span><span class="s1">][-</span><span class="s5">3</span><span class="s1">] = color</span>
            <span class="s1">sf2 = ar2.make_surface()</span>
            <span class="s1">sf3 = pygame.pixelcopy.make_surface(ar2)</span>
            <span class="s1">self.assert_surfaces_equal(sf3</span><span class="s0">, </span><span class="s1">sf2)</span>


<span class="s1">@unittest.skipIf(</span><span class="s0">not </span><span class="s1">pygame.HAVE_NEWBUF</span><span class="s0">, </span><span class="s2">&quot;newbuf not implemented&quot;</span><span class="s1">)</span>
<span class="s1">@unittest.skipIf(IS_PYPY</span><span class="s0">, </span><span class="s2">&quot;pypy having issues&quot;</span><span class="s1">)</span>
<span class="s0">class </span><span class="s1">PixelArrayNewBufferTest(unittest.TestCase</span><span class="s0">, </span><span class="s1">TestMixin):</span>

    <span class="s0">if </span><span class="s1">pygame.HAVE_NEWBUF:</span>
        <span class="s0">from </span><span class="s1">pygame.tests.test_utils </span><span class="s0">import </span><span class="s1">buftools</span>

    <span class="s1">bitsize_to_format = {</span><span class="s5">8</span><span class="s1">: </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s5">16</span><span class="s1">: </span><span class="s2">&quot;=H&quot;</span><span class="s0">, </span><span class="s5">24</span><span class="s1">: </span><span class="s2">&quot;3x&quot;</span><span class="s0">, </span><span class="s5">32</span><span class="s1">: </span><span class="s2">&quot;=I&quot;</span><span class="s1">}</span>

    <span class="s0">def </span><span class="s1">test_newbuf_2D(self):</span>
        <span class="s1">buftools = self.buftools</span>
        <span class="s1">Importer = buftools.Importer</span>

        <span class="s0">for </span><span class="s1">bit_size </span><span class="s0">in </span><span class="s1">[</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s0">, </span><span class="s5">24</span><span class="s0">, </span><span class="s5">32</span><span class="s1">]:</span>
            <span class="s1">s = pygame.Surface((</span><span class="s5">10</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s1">bit_size)</span>
            <span class="s1">ar = pygame.PixelArray(s)</span>
            <span class="s1">format = self.bitsize_to_format[bit_size]</span>
            <span class="s1">itemsize = ar.itemsize</span>
            <span class="s1">shape = ar.shape</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">h = shape</span>
            <span class="s1">strides = ar.strides</span>
            <span class="s1">length = w * h * itemsize</span>
            <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_FULL)</span>
            <span class="s1">self.assertTrue(imp.obj</span><span class="s0">, </span><span class="s1">ar)</span>
            <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
            <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
            <span class="s1">self.assertEqual(imp.format</span><span class="s0">, </span><span class="s1">format)</span>
            <span class="s1">self.assertFalse(imp.readonly)</span>
            <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
            <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
            <span class="s1">self.assertTrue(imp.suboffsets </span><span class="s0">is None</span><span class="s1">)</span>
            <span class="s1">self.assertEqual(imp.buf</span><span class="s0">, </span><span class="s1">s._pixels_address)</span>

        <span class="s1">s = pygame.Surface((</span><span class="s5">8</span><span class="s0">, </span><span class="s5">16</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar = pygame.PixelArray(s)</span>
        <span class="s1">format = self.bitsize_to_format[s.get_bitsize()]</span>
        <span class="s1">itemsize = ar.itemsize</span>
        <span class="s1">shape = ar.shape</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = shape</span>
        <span class="s1">strides = ar.strides</span>
        <span class="s1">length = w * h * itemsize</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_SIMPLE)</span>
        <span class="s1">self.assertTrue(imp.obj</span><span class="s0">, </span><span class="s1">ar)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertTrue(imp.shape </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(imp.strides </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(imp.suboffsets </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.buf</span><span class="s0">, </span><span class="s1">s._pixels_address)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_FORMAT)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.format</span><span class="s0">, </span><span class="s1">format)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_WRITABLE)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_F_CONTIGUOUS)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ANY_CONTIGUOUS)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_C_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ND)</span>

        <span class="s1">ar_sliced = ar[:</span><span class="s0">, </span><span class="s1">::</span><span class="s5">2</span><span class="s1">]</span>
        <span class="s1">format = self.bitsize_to_format[s.get_bitsize()]</span>
        <span class="s1">itemsize = ar_sliced.itemsize</span>
        <span class="s1">shape = ar_sliced.shape</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = shape</span>
        <span class="s1">strides = ar_sliced.strides</span>
        <span class="s1">length = w * h * itemsize</span>
        <span class="s1">imp = Importer(ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_STRIDED)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
        <span class="s1">self.assertEqual(imp.buf</span><span class="s0">, </span><span class="s1">s._pixels_address)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_SIMPLE)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ND)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_C_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_F_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(</span>
            <span class="s1">BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ANY_CONTIGUOUS</span>
        <span class="s1">)</span>

        <span class="s1">ar_sliced = ar[::</span><span class="s5">2</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">format = self.bitsize_to_format[s.get_bitsize()]</span>
        <span class="s1">itemsize = ar_sliced.itemsize</span>
        <span class="s1">shape = ar_sliced.shape</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = shape</span>
        <span class="s1">strides = ar_sliced.strides</span>
        <span class="s1">length = w * h * itemsize</span>
        <span class="s1">imp = Importer(ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_STRIDED)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
        <span class="s1">self.assertEqual(imp.buf</span><span class="s0">, </span><span class="s1">s._pixels_address)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_SIMPLE)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ND)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_C_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_F_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(</span>
            <span class="s1">BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar_sliced</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ANY_CONTIGUOUS</span>
        <span class="s1">)</span>

        <span class="s1">s2 = s.subsurface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">7</span><span class="s1">))</span>
        <span class="s1">ar = pygame.PixelArray(s2)</span>
        <span class="s1">format = self.bitsize_to_format[s.get_bitsize()]</span>
        <span class="s1">itemsize = ar.itemsize</span>
        <span class="s1">shape = ar.shape</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">h = shape</span>
        <span class="s1">strides = ar.strides</span>
        <span class="s1">length = w * h * itemsize</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_STRIDES)</span>
        <span class="s1">self.assertTrue(imp.obj</span><span class="s0">, </span><span class="s1">ar)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
        <span class="s1">self.assertTrue(imp.suboffsets </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.buf</span><span class="s0">, </span><span class="s1">s2._pixels_address)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_SIMPLE)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_FORMAT)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_WRITABLE)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ND)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_C_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_F_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ANY_CONTIGUOUS)</span>

    <span class="s0">def </span><span class="s1">test_newbuf_1D(self):</span>
        <span class="s1">buftools = self.buftools</span>
        <span class="s1">Importer = buftools.Importer</span>

        <span class="s1">s = pygame.Surface((</span><span class="s5">2</span><span class="s0">, </span><span class="s5">16</span><span class="s1">)</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">32</span><span class="s1">)</span>
        <span class="s1">ar_2D = pygame.PixelArray(s)</span>
        <span class="s1">x = </span><span class="s5">0</span>
        <span class="s1">ar = ar_2D[x]</span>
        <span class="s1">format = self.bitsize_to_format[s.get_bitsize()]</span>
        <span class="s1">itemsize = ar.itemsize</span>
        <span class="s1">shape = ar.shape</span>
        <span class="s1">h = shape[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">strides = ar.strides</span>
        <span class="s1">length = h * itemsize</span>
        <span class="s1">buf = s._pixels_address + x * itemsize</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_STRIDES)</span>
        <span class="s1">self.assertTrue(imp.obj</span><span class="s0">, </span><span class="s1">ar)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
        <span class="s1">self.assertTrue(imp.suboffsets </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.buf</span><span class="s0">, </span><span class="s1">buf)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_FULL)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.format</span><span class="s0">, </span><span class="s1">format)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_SIMPLE)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_FORMAT)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_WRITABLE)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ND)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_C_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_F_CONTIGUOUS)</span>
        <span class="s1">self.assertRaises(BufferError</span><span class="s0">, </span><span class="s1">Importer</span><span class="s0">, </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ANY_CONTIGUOUS)</span>
        <span class="s1">y = </span><span class="s5">10</span>
        <span class="s1">ar = ar_2D[:</span><span class="s0">, </span><span class="s1">y]</span>
        <span class="s1">shape = ar.shape</span>
        <span class="s1">w = shape[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">strides = ar.strides</span>
        <span class="s1">length = w * itemsize</span>
        <span class="s1">buf = s._pixels_address + y * s.get_pitch()</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_FULL)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertEqual(imp.format</span><span class="s0">, </span><span class="s1">format)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertEqual(imp.strides</span><span class="s0">, </span><span class="s1">strides)</span>
        <span class="s1">self.assertEqual(imp.buf</span><span class="s0">, </span><span class="s1">buf)</span>
        <span class="s1">self.assertTrue(imp.suboffsets </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_SIMPLE)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertTrue(imp.shape </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(imp.strides </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ND)</span>
        <span class="s1">self.assertEqual(imp.len</span><span class="s0">, </span><span class="s1">length)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">self.assertEqual(imp.itemsize</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s1">self.assertTrue(imp.format </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">self.assertFalse(imp.readonly)</span>
        <span class="s1">self.assertEqual(imp.shape</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">self.assertTrue(imp.strides </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_C_CONTIGUOUS)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_F_CONTIGUOUS)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">imp = Importer(ar</span><span class="s0">, </span><span class="s1">buftools.PyBUF_ANY_CONTIGUOUS)</span>
        <span class="s1">self.assertEqual(imp.ndim</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span>


<span class="s0">if </span><span class="s1">__name__ == </span><span class="s2">&quot;__main__&quot;</span><span class="s1">:</span>
    <span class="s1">unittest.main()</span>
</pre>
</body>
</html>